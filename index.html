<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mentoria MRA - M√©todo Reverso Aplicado > Simulado RPAT/RN V1</title>
  <style>
    body{
      font-family:Arial,sans-serif;
      background:#fff;
      color:#1e293b;
      display:flex;
      justify-content:center;
      padding:24px;
      margin:0
    }
    .container{
      max-width:900px;
      width:100%;
      border:1px solid #e2e8f0;
      border-radius:20px;
      box-shadow:0 4px 20px rgba(0,0,0,.08);
      overflow:hidden;
      background:#fff
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px;
      border-bottom:1px solid #e2e8f0;
      background:#f8fafc
    }
    header img{
      height:60px; /* <- ajustei pra usar sua logo.png bonitinha */
    }
    h1{
      font-size:18px;
      color:#4338ca;
      margin:0
    }
    .progress-container{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:260px
    }
    .progress-wrap{
      flex:1;
      height:10px;
      background:#e2e8f0;
      border-radius:999px;
      overflow:hidden
    }
    .progress{
      height:100%;
      width:0%;
      background:#4338ca;
      transition:width .3s
    }
    .progress-text{
      font-size:13px;
      color:#475569
    }
    main{
      padding:24px
    }
    .question{
      font-size:20px;
      margin:0 0 18px
    }
    .options{
      list-style:none;
      padding:0;
      margin:0 0 12px;
      display:grid;
      gap:12px
    }
    .option{
      border:1px solid #e2e8f0;
      padding:14px;
      border-radius:12px;
      cursor:pointer;
      background:#fff;
      transition:all .15s ease
    }
    .option.selected{
      outline:2px solid #4338ca;
      background:#fff
    }
    .option.eliminated{
      background:#fff;
      color:#64748b;
      text-decoration:line-through;
    }
    .option.correct{
      border-color:#16a34a;
      background:#ecfdf5
    }
    .option.incorrect{
      border-color:#dc2626;
      background:#fef2f2
    }

    /* bloco de explica√ß√£o por alternativa */
    .opt-expl{
      font-size:13px;
      color:#475569;
      margin-top:6px;
      display:none;
      white-space:pre-wrap;
    }

    .feedback{
      padding:12px;
      border:1px solid #e2e8f0;
      border-radius:12px;
      background:#f8fafc;
      white-space:pre-wrap;
      margin-top:12px
    }
    .feedback:empty{
      display:none;
      padding:0;
      border:0;
      margin:0
    }
    .results{
      padding:24px;
      border-top:1px solid #e2e8f0;
      display:none;
      background:#f8fafc
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px
    }
    .chip{
      font-size:12px;
      border:1px solid #e2e8f0;
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
      color:#4338ca
    }
    .controls{
      display:flex;
      gap:8px;
      margin-top:12px
    }
    .answer-wrap{
      position:relative;
      display:inline-block;
      margin-bottom:12px
    }
    .answer-wrap .tip-hint{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:125%;
      padding:10px 12px;
      border:1px dashed #94a3b8;
      border-radius:12px;
      background:#f8fafc;
      color:#334155;
      font-size:14px;
      display:none;
      opacity:0;
      box-shadow:0 6px 16px rgba(0,0,0,.08);
      white-space:nowrap;
      z-index:10
    }
    .answer-wrap:hover .tip-hint{
      display:block;
      opacity:1
    }
    .hidden{
      display:none !important
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <!-- usa logo.png que voc√™ subiu pro repo -->
    <img src="logo.png" alt="Logo Mentoria MRA">

    <h1>Mentoria MRA - M√©todo Reverso Aplicado > Simulado RPAT/RN V1</h1>

    <div class="progress-container">
      <div class="progress-wrap">
        <div id="progress" class="progress"></div>
      </div>
      <div id="progressText" class="progress-text">0%</div>
    </div>
  </header>

  <main>
    <div id="question-meta"></div>
    <h2 id="question" class="question"></h2>
    <ul id="options" class="options"></ul>

    <!-- Bot√£o responder + tooltip (hover) -->
    <div class="answer-wrap">
      <button id="answerBtn" disabled>Responder</button>
      <div id="tipHint" class="tip-hint">
        üí° <b>Dica:</b> Use as teclas <b>A, B, C, D</b> para escolher,
        <b>Enter</b> para responder,
        e as setas <b>‚Üê / ‚Üí</b> para navegar.
      </div>
    </div>

    <div id="feedback" class="feedback"></div>

    <div class="controls">
      <button id="prevBtn">‚óÄ Voltar</button>
      <button id="nextBtn" disabled>Pr√≥xima ‚ñ∂</button>
    </div>
  </main>

  <section id="results" class="results">
    <p id="scoreText"></p>

    <h3 style="margin:8px 0 0 0;color:#1e293b">T√≥picos para revisar</h3>
    <div id="reviewChips" class="chips"></div>

    <div style="margin-top:12px">
      <button id="restartBtn">Refazer</button>
    </div>
  </section>
</div>

<script>
// ====== DADOS DO QUIZ ======
const quizData = [{"questionNumber": 1, "question": "De acordo com o Art. 24 do Regulamento, como s√£o computados os prazos processuais no processo administrativo tribut√°rio do Rio Grande do Norte?", "answerOptions": [{"text": "Em dias corridos, com in√≠cio no primeiro dia √∫til subsequente √† ci√™ncia.", "isCorrect": false, "topic": "Prazos Processuais"}, {"text": "Em dias √∫teis, excluindo o dia do in√≠cio e incluindo o do vencimento.", "isCorrect": true, "topic": "Prazos Processuais"}, {"text": "Em dias corridos, incluindo o dia do in√≠cio e o do vencimento.", "isCorrect": false, "topic": "Prazos Processuais"}, {"text": "Em dias √∫teis, contando a partir do dia seguinte √† ci√™ncia e terminando na v√©spera do vencimento.", "isCorrect": false, "topic": "Prazos Processuais"}], "justification": "Explica√ß√£o:\nA - Errada: fala em dias corridos.\nB - Correta: Art. 24 do RPAT/RN determina prazos em dias √∫teis, exclu√≠do o dia do in√≠cio e inclu√≠do o do vencimento.\nC - Errada: usa dias corridos e inclui o dia inicial.\nD - Errada: exclui o dia do vencimento."}, {"questionNumber": 2, "question": "Conforme o Art. 17, se uma intima√ß√£o for disponibilizada no Domic√≠lio Tribut√°rio Eletr√¥nico (DTE-RN) e o contribuinte n√£o a consultar, quando ela ser√° considerada realizada?", "answerOptions": [{"text": "Ap√≥s 30 dias da disponibiliza√ß√£o, caso n√£o haja consulta.", "isCorrect": false, "topic": "Intima√ß√£o Eletr√¥nica"}, {"text": "Na data em que o sistema registra a disponibiliza√ß√£o da comunica√ß√£o.", "isCorrect": false, "topic": "Intima√ß√£o Eletr√¥nica"}, {"text": "No dia do t√©rmino do prazo de 10 dias, contados da data em que foi disponibilizada.", "isCorrect": true, "topic": "Intima√ß√£o Eletr√¥nica"}, {"text": "Somente quando o contribuinte efetivar a consulta eletr√¥nica, n√£o havendo prazo presumido.", "isCorrect": false, "topic": "Intima√ß√£o Eletr√¥nica"}], "justification": "Explica√ß√£o:\nA - Errada: n√£o existe prazo de 30 dias.\nB - Errada: ci√™ncia n√£o ocorre na data da disponibiliza√ß√£o sem consulta.\nC - Correta: Art. 17 prev√™ ci√™ncia presumida no 10¬∫ dia ap√≥s disponibiliza√ß√£o.\nD - Errada: a lei prev√™ ci√™ncia presumida, mesmo sem consulta."}, {"questionNumber": 3, "question": "Segundo o Art. 12, qual √© o momento correto para um interessado arguir o impedimento ou a suspei√ß√£o de uma autoridade no processo?", "answerOptions": [{"text": "Na primeira oportunidade em que couber ao interessado manifestar-se nos autos.", "isCorrect": true, "topic": "Impedimentos e Suspei√ß√£o"}, {"text": "Apenas na peti√ß√£o de recurso volunt√°rio para a segunda inst√¢ncia.", "isCorrect": false, "topic": "Impedimentos e Suspei√ß√£o"}, {"text": "No prazo de 10 dias ap√≥s tomar conhecimento do fato que gera o impedimento.", "isCorrect": false, "topic": "Impedimentos e Suspei√ß√£o"}, {"text": "A qualquer momento antes da decis√£o de primeira inst√¢ncia.", "isCorrect": false, "topic": "Impedimentos e Suspei√ß√£o"}], "justification": "Explica√ß√£o:\nA - Correta: deve ser feita na primeira oportunidade em que couber manifesta√ß√£o.\nB - Errada: restringe de forma incorreta √† segunda inst√¢ncia.\nC - Errada: o decreto n√£o fixa prazo de 10 dias.\nD - Errada: n√£o pode ser arguida a qualquer tempo, apenas no momento oportuno inicial."}, {"questionNumber": 4, "question": "Qual √© a consequ√™ncia de incorre√ß√µes ou omiss√µes em um Auto de Infra√ß√£o, de acordo com o Art. 39, ¬ß 4¬∫?", "answerOptions": [{"text": "O auto √© automaticamente arquivado, e a a√ß√£o fiscal √© considerada encerrada.", "isCorrect": false, "topic": "Auto de Infra√ß√£o"}, {"text": "Geram uma multa acess√≥ria para o auditor fiscal que o lavrou, mas o auto permanece v√°lido.", "isCorrect": false, "topic": "Auto de Infra√ß√£o"}, {"text": "N√£o acarretam a sua nulidade quando dele constarem elementos suficientes para determinar a infra√ß√£o e o infrator, e n√£o resultar preju√≠zo √† defesa.", "isCorrect": true, "topic": "Auto de Infra√ß√£o"}, {"text": "Acarretam a nulidade imediata do auto, que deve ser refeito pela autoridade fiscal.", "isCorrect": false, "topic": "Auto de Infra√ß√£o"}], "justification": "Explica√ß√£o:\nA - Errada: n√£o h√° arquivamento autom√°tico.\nB - Errada: n√£o existe multa acess√≥ria ao auditor.\nC - Correta: Art. 39, ¬ß4¬∫ aplica o princ√≠pio da instrumentalidade das formas, s√≥ h√° nulidade com preju√≠zo √† defesa.\nD - Errada: n√£o h√° nulidade imediata sem preju√≠zo."}, {"questionNumber": 5, "question": "Conforme o Art. 114, em que situa√ß√£o a autoridade julgadora de primeira inst√¢ncia √© obrigada a recorrer de of√≠cio?", "answerOptions": [{"text": "Sempre que a decis√£o exonerar o sujeito passivo do pagamento de cr√©dito tribut√°rio ou penalidade superior a R$ 15.000,00.", "isCorrect": true, "topic": "Recurso de Of√≠cio"}, {"text": "Se o sujeito passivo, mesmo sendo vencedor, indicar que ir√° recorrer sobre um ponto espec√≠fico da decis√£o.", "isCorrect": false, "topic": "Recurso de Of√≠cio"}, {"text": "Em todas as decis√µes que resultem em anula√ß√£o total do auto de infra√ß√£o, independentemente de valor.", "isCorrect": false, "topic": "Recurso de Of√≠cio"}, {"text": "Quando a decis√£o for contr√°ria a uma s√∫mula do Conselho de Recursos Fiscais.", "isCorrect": false, "topic": "Recurso de Of√≠cio"}], "justification": "Explica√ß√£o:\nA - Correta: Art. 114 obriga recurso de of√≠cio quando o valor exonerado > R$ 15.000,00.\nB - Errada: n√£o depende da vontade do sujeito passivo.\nC - Errada: n√£o √© toda anula√ß√£o, s√≥ se superar o valor limite.\nD - Errada: diverg√™ncia com s√∫mula n√£o gera recurso autom√°tico."}, {"questionNumber": 6, "question": "O que acontece com o prazo para pagamento de um tributo quando o contribuinte apresenta uma consulta sobre a mat√©ria, de acordo com o Art. 143?", "answerOptions": [{"text": "O prazo continua a correr normalmente, mas as multas s√£o anistiadas se a resposta for favor√°vel.", "isCorrect": false, "topic": "Consulta Tribut√°ria"}, {"text": "O prazo √© interrompido e recome√ßa a contar do zero ap√≥s a resposta.", "isCorrect": false, "topic": "Consulta Tribut√°ria"}, {"text": "O prazo de exigibilidade da obriga√ß√£o √© suspenso.", "isCorrect": true, "topic": "Consulta Tribut√°ria"}, {"text": "A obriga√ß√£o √© extinta, caso a consulta seja considerada pertinente.", "isCorrect": false, "topic": "Consulta Tribut√°ria"}], "justification": "Explica√ß√£o:\nA - Errada: prazo n√£o continua correndo.\nB - Errada: n√£o h√° interrup√ß√£o, mas suspens√£o.\nC - Correta: Art. 143 suspende a exigibilidade da obriga√ß√£o enquanto consulta n√£o respondida.\nD - Errada: consulta n√£o extingue obriga√ß√£o."}, {"questionNumber": 7, "question": "Segundo o Art. 156-D, qual o prazo que o contribuinte tem para apresentar impugna√ß√£o contra uma decis√£o que indefere um pedido de restitui√ß√£o de ind√©bito?", "answerOptions": [{"text": "60 dias, desde que apresente novas provas documentais.", "isCorrect": false, "topic": "Restitui√ß√£o de Ind√©bito"}, {"text": "10 dias, contados da notifica√ß√£o do indeferimento.", "isCorrect": false, "topic": "Restitui√ß√£o de Ind√©bito"}, {"text": "30 dias, contados da notifica√ß√£o do indeferimento.", "isCorrect": true, "topic": "Restitui√ß√£o de Ind√©bito"}, {"text": "15 dias, contados da publica√ß√£o da decis√£o no Di√°rio Oficial.", "isCorrect": false, "topic": "Restitui√ß√£o de Ind√©bito"}], "justification": "Explica√ß√£o:\nA - Errada: n√£o existe prazo de 60 dias.\nB - Errada: o prazo n√£o √© de 10 dias.\nC - Correta: Art. 156-D fixa 30 dias da notifica√ß√£o.\nD - Errada: prazo n√£o √© contado da publica√ß√£o no Di√°rio Oficial."}, {"questionNumber": 8, "question": "Qual √© o prazo regular para a conclus√£o de uma a√ß√£o fiscal ap√≥s seu in√≠cio, conforme o Art. 37?", "answerOptions": [{"text": "90 dias corridos, sem possibilidade de prorroga√ß√£o.", "isCorrect": false, "topic": "A√ß√£o Fiscal"}, {"text": "30 dias √∫teis, prorrog√°vel uma √∫nica vez por igual per√≠odo.", "isCorrect": false, "topic": "A√ß√£o Fiscal"}, {"text": "60 dias corridos, prorrog√°vel a crit√©rio da chefia imediata.", "isCorrect": true, "topic": "A√ß√£o Fiscal"}, {"text": "180 dias corridos, alinhado ao prazo de julgamento de processos.", "isCorrect": false, "topic": "A√ß√£o Fiscal"}], "justification": "Explica√ß√£o:\nA - Errada: n√£o √© 90 dias.\nB - Errada: n√£o s√£o 30 dias √∫teis.\nC - Correta: Art. 37 fixa 60 dias corridos, prorrog√°veis pela chefia.\nD - Errada: n√£o h√° prazo de 180 dias."}, {"questionNumber": 9, "question": "Se a autoridade julgadora de primeira inst√¢ncia n√£o proferir uma decis√£o no prazo legal, o que o sujeito passivo pode fazer, de acordo com o Art. 112?", "answerOptions": [{"text": "Considerar o lit√≠gio automaticamente encerrado a seu favor por decurso de prazo.", "isCorrect": false, "topic": "Julgamento em Primeira Inst√¢ncia"}, {"text": "Apresentar uma den√∫ncia √† corregedoria contra a autoridade julgadora, o que suspende o processo.", "isCorrect": false, "topic": "Julgamento em Primeira Inst√¢ncia"}, {"text": "Requerer √† autoridade julgadora a remessa do processo √† inst√¢ncia superior, presumindo-se a decis√£o desfavor√°vel em primeira inst√¢ncia.", "isCorrect": true, "topic": "Julgamento em Primeira Inst√¢ncia"}, {"text": "Entrar com uma a√ß√£o judicial para obrigar a autoridade a julgar o processo.", "isCorrect": false, "topic": "Julgamento em Primeira Inst√¢ncia"}], "justification": "Explica√ß√£o:\nA - Errada: n√£o h√° encerramento autom√°tico a favor do sujeito passivo.\nB - Errada: den√∫ncia n√£o suspende processo.\nC - Correta: Art. 112 permite requerer remessa √† inst√¢ncia superior, presumindo decis√£o desfavor√°vel.\nD - Errada: n√£o √© previs√£o administrativa, mas apenas judicial."}, {"questionNumber": 10, "question": "Conforme o Art. 178-A, o que pode ser exigido de um contribuinte que solicita um parcelamento de ICMS, mas possui d√©bitos inscritos em d√≠vida ativa?", "answerOptions": [{"text": "O recolhimento de uma parcela inicial equivalente a 20% dos d√©bitos consolidados.", "isCorrect": true, "topic": "Parcelamento de D√©bitos"}, {"text": "A quita√ß√£o integral de todos os d√©bitos em d√≠vida ativa antes da concess√£o do parcelamento.", "isCorrect": false, "topic": "Parcelamento de D√©bitos"}, {"text": "A apresenta√ß√£o de uma garantia real, como hipoteca de im√≥vel.", "isCorrect": false, "topic": "Parcelamento de D√©bitos"}, {"text": "A assinatura de um termo de confiss√£o de d√≠vida com ren√∫ncia a qualquer defesa futura.", "isCorrect": false, "topic": "Parcelamento de D√©bitos"}], "justification": "Explica√ß√£o:\nA - Correta: Art. 178-A exige parcela inicial de 20% dos d√©bitos consolidados.\nB - Errada: n√£o exige quita√ß√£o integral.\nC - Errada: n√£o exige garantia real.\nD - Errada: n√£o prev√™ termo de ren√∫ncia a defesa."}];

// ====== ESTADO ======
let currentIndex=0,score=0,locked=false;
const progressEl=document.getElementById('progress');
const progressText=document.getElementById('progressText');
const metaEl=document.getElementById('question-meta');
const questionEl=document.getElementById('question');
const optionsEl=document.getElementById('options');
const feedbackEl=document.getElementById('feedback');
const nextBtn=document.getElementById('nextBtn');
const prevBtn=document.getElementById('prevBtn');
const answerBtn=document.getElementById('answerBtn');
const resultsEl=document.getElementById('results');
const scoreText=document.getElementById('scoreText');
const reviewChips=document.getElementById('reviewChips');
const restartBtn=document.getElementById('restartBtn');

const topicsToReview = new Set();
let userAnswers = Array(quizData.length).fill(null); // {selectedIndex, isCorrect}
let tempSelectedIndex=null; // sele√ß√£o pr√©-resposta
let preSel = Array(quizData.length).fill(null);
let preElim = Array(quizData.length).fill(null).map(()=>new Set());

// ====== UTILS ======
function parseJustifications(justText, numOptions){
  const exps = Array(numOptions).fill("");
  if(!justText) return exps;
  const body = justText.replace(/^\s*Explica√ß√£o:\s*/i, "").trim();
  const lines = body.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  const map = {};
  lines.forEach(line=>{
    const m = line.match(/^([A-Z√Ä-√ù])\s*[-‚Äì:]\s*(.*)$/i);
    if(m){
      const letter = m[1].toUpperCase();
      map[letter] = m[2].trim();
    }
  });
  for(let i=0;i<numOptions;i++){
    const letter = String.fromCharCode(65+i);
    exps[i] = map[letter] ? map[letter] : "";
  }
  return exps;
}

function hasAnySelected(){
  return [...optionsEl.children].some(el=>el.getAttribute('data-state')==='selected');
}

function savePreAnswerState(){
  const elim = new Set();
  let sel = null;
  [...optionsEl.children].forEach((el,i)=>{
    const st = el.getAttribute('data-state')||'neutral';
    if(st==='selected') sel = i;
    if(st==='eliminated') elim.add(i);
  });
  preSel[currentIndex] = sel;
  preElim[currentIndex] = elim;
}

function restorePreAnswerState(){
  const sel = preSel[currentIndex];
  const elim = preElim[currentIndex] || new Set();
  [...optionsEl.children].forEach((el,i)=>{
    el.classList.remove('selected','eliminated');
    el.setAttribute('data-state','neutral');
    if(elim.has(i)){
      el.classList.add('eliminated');
      el.setAttribute('data-state','eliminated');
    }
  });
  if(sel!==null && sel!==undefined){
    const li = optionsEl.children[sel];
    if(li){ li.classList.add('selected'); li.setAttribute('data-state','selected'); }
    tempSelectedIndex = sel;
    answerBtn.disabled = false;
  } else {
    tempSelectedIndex = null;
    answerBtn.disabled = true;
  }
}

// ====== RENDER ======
function renderQuestion(){
  const q=quizData[currentIndex];
  const total=quizData.length;
  const pct=(currentIndex/total)*100;
  progressEl.style.width=pct+"%";
  progressText.textContent=Math.round(pct)+"%";
  metaEl.textContent=`Quest√£o ${q.questionNumber} de ${total}`;
  questionEl.textContent=q.question;

  optionsEl.innerHTML="";
  q.answerOptions.forEach((opt,idx)=>{
    const li=document.createElement('li');
    li.className="option";
    li.setAttribute('data-correct',opt.isCorrect?"1":"0");
    li.setAttribute('data-state','neutral');
    li.innerHTML=`<strong>${String.fromCharCode(65+idx)})</strong> ${opt.text}<div class="opt-expl"></div>`;
    li.addEventListener('click',()=>selectOption(idx));
    optionsEl.appendChild(li);
  });

  feedbackEl.textContent="";
  feedbackEl.innerHTML="";
  nextBtn.disabled=true; locked=false;
  tempSelectedIndex=null; answerBtn.disabled=true;

  // restaurar estados de pr√©-resposta (sele√ß√£o / eliminadas) se ainda n√£o respondida
  restorePreAnswerState();

  // Se j√° respondeu esta quest√£o, restaurar cores, explica√ß√µes e mensagem motivacional
  const saved = userAnswers[currentIndex];
  if(saved){
    // limpar estados visuais de pr√©-resposta
    [...optionsEl.children].forEach(opt=>{
      opt.classList.remove('correct','incorrect','selected','eliminated');
      opt.setAttribute('data-state','neutral');
    });

    const opts = [...optionsEl.children];
    // aplicar cores conforme regra
    if(saved.isCorrect){
      opts[saved.selectedIndex]?.classList.add('correct');
    } else {
      opts[saved.selectedIndex]?.classList.add('incorrect');
      const correctOpt = opts.find(o => o.getAttribute('data-correct') === "1");
      if(correctOpt) correctOpt.classList.add('correct');
    }

    // mostrar explica√ß√µes por alternativa
    const expsR = parseJustifications(q.justification, q.answerOptions.length);
    opts.forEach((optEl,i)=>{
      const span = optEl.querySelector('.opt-expl');
      if(span){ span.textContent = expsR[i] || ''; span.style.display='block'; }
    });

    // mensagem motivacional
    if(saved.isCorrect){
      feedbackEl.innerHTML = "<strong style='color:#16a34a'>Parab√©ns! Voc√™ acertou! Apaixone-se por estudar, pois isso mudar√° a sua vida.</strong>";
    } else {
      feedbackEl.innerHTML = "<strong style='color:#dc2626'>Alternativa incorreta! Mas lembre-se, voc√™ n√£o erra... Voc√™ acerta ou aprende.</strong>";
    }

    nextBtn.disabled = false;
    answerBtn.disabled = true;
    locked = true;
  }

  prevBtn.disabled = currentIndex === 0;
}

// ====== INTERA√á√ÉO ======
function selectOption(idx){
  if(locked) return;
  const li = optionsEl.children[idx];
  const cur = li.getAttribute('data-state') || 'neutral';

  let next = 'neutral';
  if(cur==='neutral') next='selected';
  else if(cur==='selected') next='eliminated';
  else if(cur==='eliminated') next='neutral';

  // selecionar => garantir √∫nica selecionada
  if(next==='selected'){
    [...optionsEl.children].forEach((opt,i)=>{
      if(i!==idx && opt.getAttribute('data-state')==='selected'){
        opt.classList.remove('selected');
        opt.setAttribute('data-state','neutral');
      }
    });
  }
  li.classList.remove('selected','eliminated');
  li.setAttribute('data-state', next);
  if(next==='selected') li.classList.add('selected');
  if(next==='eliminated') li.classList.add('eliminated');

  tempSelectedIndex = hasAnySelected() ? [...optionsEl.children].findIndex(el=>el.getAttribute('data-state')==='selected') : null;
  answerBtn.disabled = tempSelectedIndex===null;

  savePreAnswerState();
}

function handleAnswerByIndex(idx){
  if(locked) return;
  if(idx===null || idx===undefined) return;
  locked = true;

  const li = optionsEl.children[idx];
  const isCorrect = li.getAttribute('data-correct') === "1";
  const q = quizData[currentIndex];

  // Remover estados de pr√©-resposta e neutralizar
  [...optionsEl.children].forEach(opt=>{
    opt.classList.remove('correct','incorrect','selected','eliminated');
    opt.setAttribute('data-state','neutral');
  });

  // Aplicar cores conforme regra
  if(isCorrect){
    li.classList.add('correct');
  } else {
    li.classList.add('incorrect');
    const correctOpt = [...optionsEl.children].find(o => o.getAttribute('data-correct') === "1");
    if(correctOpt) correctOpt.classList.add('correct');
  }

  // Pontua√ß√£o e revis√£o
  if(isCorrect){
    score++;
  } else {
    const topic = (q.answerOptions && q.answerOptions[0] && q.answerOptions[0].topic) ? q.answerOptions[0].topic : "";
    if(topic) topicsToReview.add(topic);
  }

  // Registrar resposta do usu√°rio
  userAnswers[currentIndex] = { selectedIndex: idx, isCorrect };

  // Explica√ß√µes por alternativa
  const exps = parseJustifications(q.justification, q.answerOptions.length);
  [...optionsEl.children].forEach((optEl,i)=>{
    const span = optEl.querySelector('.opt-expl');
    if(span){ span.textContent = exps[i] || ''; span.style.display='block'; }
  });

  // Mensagem motivacional
  if(isCorrect){
    feedbackEl.innerHTML = "<strong style='color:#16a34a'>Parab√©ns! Voc√™ acertou! Apaixone-se por estudar, pois isso mudar√° a sua vida.</strong>";
  } else {
    feedbackEl.innerHTML = "<strong style='color:#dc2626'>Alternativa incorreta! Mas lembre-se, voc√™ n√£o erra... Voc√™ acerta ou aprende.</strong>";
  }

  nextBtn.disabled = false;
  answerBtn.disabled = true;
}

function nextQuestion(){
  if(currentIndex<quizData.length-1){
    currentIndex++; renderQuestion();
  } else { showResults(); }
}

function prevQuestion(){
  if(currentIndex>0){
    currentIndex--; renderQuestion();
  }
}

function showResults(){
  progressEl.style.width="100%";
  progressText.textContent="100%";
  document.querySelector('main').style.display="none";
  resultsEl.style.display="block";
  scoreText.textContent=`Voc√™ acertou ${score} de ${quizData.length} quest√µes (${Math.round((score/quizData.length)*100)}%).`;

  // chips de revis√£o
  reviewChips.innerHTML="";
  if(topicsToReview.size===0){
    const span=document.createElement('span');
    span.className="chip";
    span.textContent="Nenhum t√≥pico marcado üéØ";
    reviewChips.appendChild(span);
  } else {
    [...topicsToReview].forEach(t=>{
      const span=document.createElement('span');
      span.className="chip";
      span.textContent=t;
      reviewChips.appendChild(span);
    });
  }
}

function restart(){
  currentIndex=0; score=0; topicsToReview.clear();
  userAnswers = Array(quizData.length).fill(null);
  preSel = Array(quizData.length).fill(null);
  preElim = Array(quizData.length).fill(null).map(()=>new Set());
  document.querySelector('main').style.display="block";
  resultsEl.style.display="none";
  renderQuestion();
}

// ====== ATALHOS DE TECLADO ======
document.addEventListener('keydown', (e)=>{
  // Evitar atalhos se j√° estiver na tela de resultados
  if(resultsEl.style.display === "block") return;

  const key = e.key.toLowerCase();
  const letters = { 'a':0, 'b':1, 'c':2, 'd':3 };

  // Sele√ß√£o / elimina√ß√£o via A/B/C/D (cicla como o clique)
  if(!locked && key in letters){
    const idx = letters[key];
    if(optionsEl.children[idx]){
      selectOption(idx);
      e.preventDefault();
    }
  }

  // Enter para responder (se houver sele√ß√£o e n√£o estiver bloqueado)
  if(key === 'enter'){
    if(!locked && typeof tempSelectedIndex === 'number'){
      handleAnswerByIndex(tempSelectedIndex);
      e.preventDefault();
    }
  }

  // Setas para navegar
  if(key === 'arrowleft'){
    if(currentIndex > 0){
      prevQuestion();
      e.preventDefault();
    }
  }
  if(key === 'arrowright'){
    if(!nextBtn.disabled){
      nextQuestion();
      e.preventDefault();
    }
  }
});

// ====== EVENTS (cliques) ======
nextBtn.addEventListener('click',nextQuestion);
prevBtn.addEventListener('click',prevQuestion);
answerBtn.addEventListener('click',()=>handleAnswerByIndex(tempSelectedIndex));
restartBtn.addEventListener('click',restart);

// Inicializar
renderQuestion();
</script>
</body>
</html>
